@inherits LayoutComponentBase

@using ConventionGradingSystem.DataAccess.Configuration
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Options
@using MudBlazor

@inject AuthenticationProvider AuthenticationProvider
@inject IOptions<ApplicationConfiguration> Configuration
@inject NavigationManager NavigationManager

<AuthorizeView Roles="Administrator">
    <Authorized>

        <MudThemeProvider IsDarkMode="true" />
        <MudPopoverProvider />

        <MudLayout>

            <MudAppBar>
                <MudIconButton
                    title="Главное меню"
                    Icon="@Icons.Material.Filled.Menu"
                    Variant="Variant.Outlined"
                    Color="Color.Primary"
                    Edge="Edge.Start"
                    OnClick="ToogleDrawer" />

                <MudImage Src="favicon-32.png" Class="ml-5" />
                <MudText Typo="Typo.h6" Class="ml-2">Система оценивания слёта <strong>@_conventionName</strong></MudText>

                <MudSpacer />
                <MudIconButton
                    title="Выйти из системы"
                    Icon="@Icons.Material.Filled.Logout"
                    Variant="Variant.Outlined"
                    OnClick="OnSignOutFromSystem" />
            </MudAppBar>

            <MudDrawer ClipMode="DrawerClipMode.Docked" Width="300px" @bind-Open="@_isDrawerOpen">
                <MudDrawerHeader>
                    <MudText Typo="Typo.subtitle1">Главное меню</MudText>
                </MudDrawerHeader>
                <MudNavMenu Bordered="true">

                    <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Главная страница</MudNavLink>

                    @if (_contestsSectionAvailable)
                    {
                        <MudNavLink Href="/contests" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Star">Конкурсы мероприятий</MudNavLink>
                    }
                    @if (_votingsSectionAvailable)
                    {
                        <MudNavLink Href="/votings" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.HowToVote">Зрительские голосования</MudNavLink>
                    }
                    @if (_teamsSectionAvailable)
                    {
                        <MudNavLink Href="/teams" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Groups">Команды участников</MudNavLink>
                    }

                </MudNavMenu>
            </MudDrawer>

            <MudMainContent>
                <MudContainer Fixed="true" Class="pt-3">
                    @Body
                </MudContainer>
            </MudMainContent>

        </MudLayout>
    </Authorized>

    <NotAuthorized>
        <PageTitle>Вход в систему</PageTitle>
        <LayoutView Layout="@typeof(BaseLayout)">
            <SignInForm />
        </LayoutView>
    </NotAuthorized>

</AuthorizeView>

@code {

    private string _conventionName = string.Empty;

    private bool _contestsSectionAvailable = false;
    private bool _votingsSectionAvailable = false;
    private bool _teamsSectionAvailable = false;

    private bool _isDrawerOpen = false;

    protected override void OnInitialized()
    {
        _conventionName = Configuration.Value.ConventionName;

        _contestsSectionAvailable = Configuration.Value.Contests.Count > 0;
        _votingsSectionAvailable = Configuration.Value.Votings.Count > 0;
        _teamsSectionAvailable =
            Configuration.Value.Teams.Count > 0 &&
            Configuration.Value.Contests.Count > 0;
    }

    private void ToogleDrawer() => _isDrawerOpen = !_isDrawerOpen;
    private async Task OnSignOutFromSystem()
    {
        await AuthenticationProvider.SignOut();
        NavigationManager.NavigateTo(NavigationManager.Uri, true);
    }
}
